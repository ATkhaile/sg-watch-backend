# 生産管理システム 要件仕様書 (v0.3)

## 1. 概要
本システムは、Laravel(API) + Next.js(フロント) により構築する。  
対象範囲は以下：
- プロジェクトマスタ管理
- 従業員マスタ管理
- 工数ログ（1分刻み）管理・CSV出力
- Help（支援要請）管理
- プロジェクト収益/原価/利益算出・可視化

---

## 2. データモデル

### 2.1 projects（プロジェクト）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| code | string | プロジェクトコード |
| name | string | プロジェクト名 |
| client_name | string | クライアント |
| start_date / end_date | date | 期間 |
| planned_hours | int | 計画工数(h換算) |
| contract_amount | decimal(12,2) | 受注金額 |
| external_cost_budget | decimal(12,2) | 外注費予算 |
| external_cost_actual | decimal(12,2) | 外注費実績(キャッシュ) |
| status | enum | planned/active/on_hold/completed/canceled |
| progress_method | enum | hours_based/milestone_based |
| description | text | 備考 |
| timestamps | | |
| softDeletes | | |

---

### 2.2 external_costs（外注費明細）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| project_id | FK | |
| vendor_name | string | 発注先 |
| category | enum | dev/design/qa/translation/other |
| amount | decimal(12,2) | 金額 |
| tax_excluded | bool | 税抜/税込 |
| invoice_date | date | 請求日 |
| paid_at | datetime | 支払日 |
| memo | text | 備考 |
| attachments | json | 添付 |
| timestamps | | |
| softDeletes | | |

---

### 2.3 employees（従業員）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| employee_code | string | 社員コード |
| name | string | 氏名 |
| email | string(unique) | メール |
| role | enum | admin/manager/member |
| active | bool | 有効/退職 |
| standard_hours_per_month | int | 想定稼働時間 (default 160) |
| visibility_scope | enum | normal/financial_restricted |
| timestamps | | |
| softDeletes | | |

---

### 2.4 employee_compensations（従業員給与履歴）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| employee_id | FK | |
| salary_monthly | decimal(12,2) | 月給（原価ベース） |
| effective_from | date | 適用開始日 |
| effective_to | date | 適用終了日 |
| overhead_rate | decimal(5,4) | 上乗せ率 (例:0.2=20%) |
| memo | text | 備考 |
| timestamps | | |

---

### 2.5 project_members（配属）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| project_id | FK | |
| employee_id | FK | |
| member_role | string | 役割 |
| allocation_rate | int | 配分率(%) |
| start_date / end_date | date | 期間 |
| timestamps | | |

---

### 2.6 work_logs（工数ログ）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| project_id | FK | |
| employee_id | FK | |
| work_date | date | 作業日 |
| duration_minutes | int | 稼働時間（分単位） |
| started_at / ended_at | datetime | 任意 |
| category | enum | dev/design/mtg/test/ops |
| task_title | string | 作業タイトル |
| note | text | 備考 |
| is_billable | bool | 請求対象フラグ |
| approved_by / approved_at | FK/datetime | 承認情報 |
| timestamps | | |

---

### 2.7 help_requests（Help要請）
| カラム名 | 型 | 説明 |
|----------|------|------|
| id | PK | |
| project_id | FK | |
| requester_id | FK | 依頼者 |
| assignee_id | FK | 担当者 |
| title | string | 要請タイトル |
| description | text | 詳細 |
| severity | enum | low/medium/high/critical |
| status | enum | open/triaged/in_progress/resolved/wont_fix/canceled |
| blocker | bool | 進捗阻害フラグ |
| related_work_log_id | FK | 関連工数 |
| sla_due_at | datetime | 期限 |
| resolved_at | datetime | 解決日時 |
| timestamps | | |
| softDeletes | | |

---

## 3. 利益計算ロジック

- 売上 = `projects.contract_amount`
- 外注費 = `Σ external_costs.amount`
- 自社工数原価 = `Σ(work_logs.minutes × 従業員 minute_cost)`
- minute_cost = `(salary_monthly * (1 + overhead_rate)) / standard_hours_per_month / 60`
- 粗利 = 売上 - 外注費 - 自社工数原価
- 粗利率 = 粗利 / 売上 × 100

---

## 4. 画面構成 (Next.js)

- **ダッシュボード**
  - プロジェクト進捗バー
  - KPI：計画工数 / 実績工数 / 差異
  - 財務：売上 / 外注費 / 労務費 / 粗利 / 粗利率
  - Blockers件数（Help）
- **プロジェクト詳細**
  - 概要（進捗・財務）
  - 外注費タブ（明細CRUD）
  - 工数タブ（週ビュー入力・CSV出力）
  - Helpタブ（Kanban/List）
- **従業員詳細**
  - 基本情報
  - プロジェクト別稼働/原価寄与
  - 給与履歴（管理者のみ）

---

## 5. API エンドポイント例

### プロジェクト
- `GET /projects`
- `GET /projects/{id}/financials?from&to`
- `POST /projects`
- `PUT /projects/{id}`

### 工数
- `GET /work-logs?project_id&employee_id&from&to`
- `POST /work-logs`（1件/バルク）
- `GET /reports/worklogs.csv`

### 外注費
- `GET /external-costs?project_id`
- `POST /external-costs`
- `PUT /external-costs/{id}`

### 従業員/給与
- `GET /employees`
- `GET /employees/{id}/compensations`
- `POST /employees/{id}/compensations`

### Help
- `GET /help-requests?project_id&status&severity`
- `POST /help-requests`
- `PUT /help-requests/{id}`（status/assignee等）
- `POST /help-requests/{id}/comments`

---

## 6. CSV 出力フォーマット

### 工数明細
project_code,employee_code,employee_name,work_date,started_at,ended_at,duration_minutes,duration_hhmm,category,task_title,is_billable

shell
Copy
Edit

### プロジェクトP/L
project_code,project_name,client_name,revenue,external_cost,labor_cost,gross_profit,gross_margin

shell
Copy
Edit

### 外注費明細
project_code,vendor_name,category,invoice_date,amount,paid_at,memo

shell
Copy
Edit

### 従業員原価寄与
employee_code,employee_name,project_code,minutes,hours,minute_cost,amount

shell
Copy
Edit

### Helpログ
id,project_code,requester,assignee,status,severity,blocker,sla_due_at,created_at,resolved_at,title

yaml
Copy
Edit

---

## 7. 権限/セキュリティ

- 一般ユーザ：工数入力・Help作成のみ
- Manager：プロジェクト配属・承認
- Admin/Finance権限：給与・外注費・利益情報
- CSV出力は権限制御
- 監査ログ：給与・外注費・CSV出力操作を記録

---

## 8. 非機能要件

- DB: MySQL / MariaDB, UTF-8, Asia/Tokyo
- 小数誤差対策：decimal(12,2)、minute_costは小数4桁保持
- パフォーマンス：work_logsに(project_id, work_date)インデックス
- バックアップ：DB日次スナップショット
- 通知：Help作成/変更はWebSocket+メール/Slack通知